---
title: ä½¿ç”¨ HertzBeat å¯¹ API ç½‘å…³ Apache ShenYu çš„ç›‘æ§å®è·µ    
author: tom  
author_title: tom   
author_url: https://github.com/tomsun28  
author_image_url: https://avatars.githubusercontent.com/u/24788200?s=400&v=4  
tags: [opensource, practice]
---

## ä½¿ç”¨ HertzBeat å¯¹ API ç½‘å…³ Apache ShenYu è¿›è¡Œç›‘æ§å®è·µï¼Œ5åˆ†é’Ÿæå®šï¼

### Apache ShenYu ä»‹ç»  

> Apache ShenYu ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚      

- ä»£ç†ï¼šæ”¯æŒApache Dubboï¼ŒSpring Cloudï¼ŒgRPCï¼ŒMotanï¼ŒSOFAï¼ŒTARSï¼ŒWebSocketï¼ŒMQTT
- å®‰å…¨æ€§ï¼šç­¾åï¼ŒOAuth 2.0ï¼ŒJSON Webä»¤ç‰Œï¼ŒWAFæ’ä»¶
- APIæ²»ç†ï¼šè¯·æ±‚ã€å“åº”ã€å‚æ•°æ˜ å°„ã€Hystrixã€RateLimiteræ’ä»¶
- å¯è§‚æµ‹æ€§ï¼šè·Ÿè¸ªã€æŒ‡æ ‡ã€æ—¥å¿—è®°å½•æ’ä»¶
- ä»ªè¡¨æ¿ï¼šåŠ¨æ€æµé‡æ§åˆ¶ï¼Œç”¨æˆ·èœå•æƒé™çš„å¯è§†åŒ–åç«¯
- æ‰©å±•ï¼šæ’ä»¶çƒ­æ’æ‹”ï¼ŒåŠ¨æ€åŠ è½½
- é›†ç¾¤ï¼šNGINXã€Dockerã€Kubernetes
- è¯­è¨€ï¼šæä¾›.NETï¼ŒPythonï¼ŒGoï¼ŒJavaå®¢æˆ·ç«¯ç”¨äºAPIæ³¨å†Œ


### HertzBeat ä»‹ç»  

> HertzBeat æ˜¯ä¸€æ¬¾å¼€æºï¼Œæ˜“ç”¨å‹å¥½çš„å®æ—¶ç›‘æ§å·¥å…·ï¼Œæ— éœ€Agentï¼Œæ‹¥æœ‰å¼ºå¤§è‡ªå®šä¹‰ç›‘æ§èƒ½åŠ›ã€‚    
> æ”¯æŒå¯¹åº”ç”¨æœåŠ¡ï¼Œæ•°æ®åº“ï¼Œæ“ä½œç³»ç»Ÿï¼Œä¸­é—´ä»¶ï¼Œäº‘åŸç”Ÿç­‰ç›‘æ§ï¼Œé˜ˆå€¼å‘Šè­¦ï¼Œå‘Šè­¦é€šçŸ¥(é‚®ä»¶å¾®ä¿¡é’‰é’‰é£ä¹¦)ã€‚    
> HertzBeat çš„å¼ºå¤§è‡ªå®šä¹‰ï¼Œå¤šç±»å‹æ”¯æŒï¼Œæ˜“æ‰©å±•ï¼Œä½è€¦åˆï¼Œå¸Œæœ›èƒ½å¸®åŠ©å¼€å‘è€…å’Œä¸­å°å›¢é˜Ÿå¿«é€Ÿæ­å»ºè‡ªæœ‰ç›‘æ§ç³»ç»Ÿã€‚  

### åœ¨ HertzBeat 5åˆ†é’Ÿæå®šç›‘æ§ Apache ShenYu

#### æ“ä½œå‰æï¼Œæ‚¨å·²æ‹¥æœ‰ ShenYu ç¯å¢ƒå’Œ HertzBeat ç¯å¢ƒã€‚  

- ShenYu [éƒ¨ç½²å®‰è£…æ–‡æ¡£](https://shenyu.apache.org/zh/docs/deployment/deployment-before)   
- HertzBeat [éƒ¨ç½²å®‰è£…æ–‡æ¡£](https://hertzbeat.com/docs/start/docker-deploy)   

#### ä¸€. åœ¨ ShenYu ç«¯å¼€å¯`metrics`æ’ä»¶ï¼Œå®ƒå°†æä¾› metrics æ¥å£æ•°æ®ã€‚

> æ’ä»¶æ˜¯ Apache ShenYu ç½‘å…³çš„æ ¸å¿ƒæ‰§è¡Œè€…ï¼ŒæŒ‡æ ‡æ•°æ®é‡‡é›†åœ¨ `ShenYu` ä¹Ÿæ˜¯ä»¥æ’ä»¶çš„å½¢å¼é›†æˆçš„ - `Metricsæ’ä»¶`ã€‚     
> `Metricsæ’ä»¶`æ˜¯ç½‘å…³ç”¨æ¥ç›‘æ§è‡ªèº«è¿è¡ŒçŠ¶æ€ï¼ˆ`JVM`ç›¸å…³ï¼‰ï¼Œè¯·æ±‚å“åº”ç­‰ç›¸å…³æŒ‡æ ‡è¿›è¡Œç›‘æµ‹ã€‚

1. åœ¨ç½‘å…³çš„ `pom.xml` æ–‡ä»¶ä¸­æ·»åŠ  `metricsæ’ä»¶` çš„ä¾èµ–ã€‚

```xml
        <dependency>
            <groupId>org.apache.shenyu</groupId>
            <artifactId>shenyu-spring-boot-starter-plugin-metrics</artifactId>
            <version>${project.version}</version>
        </dependency>
```

2. `metric`æ’ä»¶ é‡‡é›†é»˜è®¤æ˜¯å…³é—­çš„, åœ¨ç½‘å…³çš„é…ç½®`yaml`æ–‡ä»¶ä¸­ç¼–è¾‘å¦‚ä¸‹å†…å®¹ï¼š

```yaml
shenyu:
  metrics:
    enabled: true  #è®¾ç½®ä¸º true è¡¨ç¤ºå¼€å¯
    name : prometheus 
    host: 127.0.0.1 #æš´éœ²çš„ip
    port: 8090 #æš´éœ²çš„ç«¯å£
    jmxConfig: #jmxé…ç½®
    props:
      jvm_enabled: true #å¼€å¯jvmçš„ç›‘æ§æŒ‡æ ‡
```

3. é‡å¯ ShenYuç½‘å…³, æ‰“å¼€æµè§ˆå™¨æˆ–è€…ç”¨curl è®¿é—® `http://ip:8090`, å°±èƒ½çœ‹åˆ°metricæ•°æ®äº†ã€‚ 

#### äºŒ. åœ¨ HertzBeat ç›‘æ§é¡µé¢æ·»åŠ  ShenYu ç›‘æ§   

1. ç‚¹å‡»æ–°å¢ ShenYu ç›‘æ§  

è·¯å¾„ï¼šèœå• -> ä¸­é—´ä»¶ç›‘æ§ -> ShenYuç›‘æ§ -> æ–°å¢ShenYuç›‘æ§  

![hertzbeat](/img/blog/monitor-shenyu-1.png)   

2. é…ç½®ç›‘æ§ ShenYu æ‰€éœ€å‚æ•°   

åœ¨ç›‘æ§é¡µé¢å¡«å†™ ShenYu **æœåŠ¡IP**ï¼Œ**ç›‘æ§ç«¯å£**(é»˜è®¤8090)ï¼Œæœ€åç‚¹å‡»ç¡®å®šæ·»åŠ å³å¯ã€‚   
å…¶ä»–å‚æ•°å¦‚**é‡‡é›†é—´éš”**ï¼Œ**è¶…æ—¶æ—¶é—´**ç­‰å¯ä»¥å‚è€ƒ[å¸®åŠ©æ–‡æ¡£](https://hertzbeat.com/docs/help/shenyu/) https://hertzbeat.com/docs/help/shenyu/   

![hertzbeat](/img/blog/monitor-shenyu-1.png)    

3. å®Œæˆâœ…,ç°åœ¨æˆ‘ä»¬å·²ç»æ·»åŠ å¥½å¯¹ ShenYu çš„ç›‘æ§äº†ï¼ŒæŸ¥çœ‹ç›‘æ§åˆ—è¡¨å³å¯çœ‹åˆ°æˆ‘ä»¬çš„æ·»åŠ é¡¹ã€‚  

![hertzbeat](/img/blog/monitor-shenyu-3.png)  

4. ç‚¹å‡»ç›‘æ§åˆ—è¡¨é¡¹çš„**æ“ä½œ**->**ç›‘æ§è¯¦æƒ…å›¾æ ‡** å³å¯æµè§ˆ ShenYu çš„å®æ—¶ç›‘æ§æŒ‡æ ‡æ•°æ®ã€‚  

![hertzbeat](/img/blog/monitor-shenyu-4.png)  

5. ç‚¹å‡»**ç›‘æ§å†å²è¯¦æƒ…TAB** å³å¯æµè§ˆ ShenYu çš„å†å²ç›‘æ§æŒ‡æ ‡æ•°æ®å›¾è¡¨ğŸ“ˆã€‚  

![hertzbeat](/img/blog/monitor-shenyu-5.png)      

![hertzbeat](/img/blog/monitor-shenyu-6.png)

**DONEï¼å®Œæˆå•¦ï¼é€šè¿‡ä¸Šé¢å‡ æ­¥ï¼Œæ€»ç»“èµ·æ¥å…¶å®ä¹Ÿå°±åªç”¨ä¸¤æ­¥**  
- **ç¬¬ä¸€æ­¥å¼€å¯ ShenYu ç«¯`metrics`æ’ä»¶åŠŸèƒ½**   
- **ç¬¬äºŒæ­¥åœ¨ HertzBeat ç›‘æ§é¡µé¢é…ç½®IPç«¯å£æ·»åŠ ç›‘æ§å³å¯**         

:::tip
é€šè¿‡ä¸Šé¢çš„ä¸¤æ­¥æˆ‘ä»¬å°±å®Œæˆäº†å¯¹ Apache ShenYu çš„ç›‘æ§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ HertzBeat éšæ—¶æŸ¥çœ‹ç›‘æ§è¯¦æƒ…æŒ‡æ ‡ä¿¡æ¯æ¥è§‚æµ‹å…¶æœåŠ¡çŠ¶æ€ã€‚
å½“ç„¶åªæ˜¯çœ‹è‚¯å®šæ˜¯ä¸å®Œç¾çš„ï¼Œç›‘æ§å¾€å¾€ä¼´éšç€å‘Šè­¦é˜ˆå€¼ï¼Œå½“ ShenYu çš„æŸäº›æŒ‡æ ‡è¶…å‡ºæˆ‘ä»¬çš„æœŸæœ›å€¼æˆ–å¼‚å¸¸æ—¶ï¼Œèƒ½åŠæ—¶çš„é€šçŸ¥åˆ°æˆ‘ä»¬å¯¹åº”çš„è´Ÿè´£äººï¼Œè´Ÿè´£äººæ”¶åˆ°é€šçŸ¥å¤„ç†é—®é¢˜ï¼Œè¿™æ ·æ‰æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§å‘Šè­¦æµç¨‹ã€‚
:::

**æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ä¸€æ­¥ä¸€æ­¥æ¼”ç¤ºå¦‚ä½•é…ç½® HertzBeat ç³»ç»Ÿé‡Œçš„é˜ˆå€¼å‘Šè­¦é€šçŸ¥ï¼Œè®© ShenYu çš„æŒ‡æ ‡å¼‚å¸¸æ—¶ï¼ŒåŠæ—¶é€šçŸ¥ç»™æˆ‘ä»¬**     

#### ä¸‰. åœ¨ HertzBeat ç³»ç»Ÿæ·»åŠ  ShenYu æŒ‡æ ‡é˜ˆå€¼å‘Šè­¦   

1. å¯¹æŸä¸ªé‡è¦æŒ‡æ ‡é…ç½®å‘Šè­¦é˜ˆå€¼     

è·¯å¾„ï¼šèœå• -> å‘Šè­¦é˜ˆå€¼ -> æ–°å¢é˜ˆå€¼  

- é€‰æ‹©é…ç½®çš„æŒ‡æ ‡å¯¹è±¡ï¼ŒShenYu ç›‘æ§æœ‰éå¸¸å¤šçš„æŒ‡æ ‡ï¼Œæˆ‘ä»¬ä¸¾ä¾‹å¯¹ `æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡` `process_open_fds` -> `value` è¿™ä¸ªæŒ‡æ ‡è¿›è¡Œé˜ˆå€¼è®¾ç½®ï¼Œ å½“æœåŠ¡ç«¯æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¤§äº3000æ—¶å‘å‡ºå‘Šè­¦ã€‚       
- è¿™é‡Œæˆ‘ä»¬å°±é…ç½®å½“æ­¤æŒ‡æ ‡`process_open_fds` çš„ `value>3000` æ—¶å‘å‡ºå‘Šè­¦ï¼Œå‘Šè­¦çº§åˆ«ä¸º**è­¦å‘Šå‘Šè­¦**ï¼Œä¸‰æ¬¡å³è§¦å‘ï¼Œå…·ä½“å¦‚ä¸‹å›¾ã€‚  

![hertzbeat](/img/blog/monitor-shenyu-7.png)    


2. æ–°å¢æ¶ˆæ¯é€šçŸ¥æ¥æ”¶äºº

> é…ç½®æ¥æ”¶äººï¼Œè®©å‘Šè­¦æ¶ˆæ¯çŸ¥é“è¦å‘ç»™è°ï¼Œç”¨ä»€ä¹ˆæ–¹å¼å‘ã€‚  

è·¯å¾„ï¼šèœå• -> å‘Šè­¦é€šçŸ¥ -> å‘Šè­¦æ¥æ”¶äºº -> æ–°å¢æ¥æ”¶äºº  

æ¶ˆæ¯é€šçŸ¥æ–¹å¼æ”¯æŒ **é‚®ä»¶ï¼Œé’‰é’‰ï¼Œä¼ä¸šå¾®ä¿¡ï¼Œé£ä¹¦ï¼ŒWebHookï¼ŒçŸ­ä¿¡**ç­‰ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥å¸¸ç”¨çš„é’‰é’‰ä¸ºä¾‹ã€‚  

- å‚ç…§æ­¤[å¸®åŠ©æ–‡æ¡£](https://hertzbeat.com/docs/help/alert_dingtalk) https://hertzbeat.com/docs/help/alert_dingtalk åœ¨é’‰é’‰ç«¯é…ç½®æœºå™¨äººï¼Œè®¾ç½®å®‰å…¨è‡ªå®šä¹‰å…³é”®è¯`HertzBeat`ï¼Œè·å–å¯¹åº”`access_token`å€¼ã€‚ 
- åœ¨ HertzBeat é…ç½®æ¥æ”¶äººå‚æ•°å¦‚ä¸‹ã€‚  

ã€å‘Šè­¦é€šçŸ¥ã€‘->ã€æ–°å¢æ¥æ”¶äººã€‘ ->ã€é€‰æ‹©é’‰é’‰æœºå™¨äººé€šçŸ¥æ–¹å¼ã€‘->ã€è®¾ç½®é’‰é’‰æœºå™¨äººACCESS_TOKENã€‘-> ã€ç¡®å®šã€‘

![hertzbeat](/img/blog/alert-notice-1.png)    

3. é…ç½®å…³è”çš„å‘Šè­¦é€šçŸ¥ç­–ç•¥âš ï¸ ã€æ–°å¢é€šçŸ¥ç­–ç•¥ã€‘-> ã€å°†åˆšè®¾ç½®çš„æ¥æ”¶äººå…³è”ã€‘-> ã€ç¡®å®šã€‘ 

> é…ç½®å‘Šè­¦é€šçŸ¥ç­–ç•¥ï¼Œè®©å‘Šè­¦æ¶ˆæ¯ä¸æ¥æ”¶äººç»‘å®šï¼Œè¿™æ ·å°±èƒ½å†³å®šå“ªäº›å‘Šè­¦å‘ç»™å“ªä¸ªäººã€‚

![hertzbeat](/img/blog/alert-notice-2.png)    


### å®Œæ¯•ï¼Œç°åœ¨åç­‰å‘Šè­¦æ¶ˆæ¯è¿‡æ¥å•¦ã€‚å®å®å®å® 

```
[HertzBeatå‘Šè­¦é€šçŸ¥]
å‘Šè­¦ç›®æ ‡å¯¹è±¡ : shenyu.process_open_fds.value
æ‰€å±ç›‘æ§ä»»åŠ¡ID : 205540620349696
æ‰€å±ä»»åŠ¡åç§° : SHENYU_localhost
å‘Šè­¦çº§åˆ« : è­¦å‘Šå‘Šè­¦
å‘Šè­¦è§¦å‘æ—¶é—´ : 2023-01-08 22:17:06
å†…å®¹è¯¦æƒ… : è¯·æ³¨æ„âš ï¸ ShenYuç½‘å…³æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ä¸º 3044 è¶…è¿‡3000
```

## å°ç»“   

:::tip
è¿™ç¯‡å®è·µæ–‡ç« å¸¦æˆ‘ä»¬ä½“éªŒäº†å¦‚ä½•ä½¿ç”¨ HertzBeat ç›‘æ§ Apache ShenYu æŒ‡æ ‡æ•°æ®ï¼Œå¯ä»¥å‘ç°å°† `ç›‘æ§-å‘Šè­¦-é€šçŸ¥` é›†ä¸€ä½“çš„ HertzBeat åœ¨æ“ä½œä¸ä½¿ç”¨æ–¹é¢æ›´åŠ çš„ä¾¿æ·ï¼Œåœ¨é¡µé¢ä¸Šç®€å•ç‚¹ä¸€ç‚¹å°±èƒ½æŠŠ ShenYu çº³å…¥ç›‘æ§ï¼Œå†ä¹Ÿä¸éœ€è¦éƒ¨ç½²å¤šä¸ªç»„ä»¶ï¼Œå†™å¤šä¸ªæœ‰é—¨æ§›çš„YMLé…ç½®æ–‡ä»¶äº†ã€‚  
:::

Apache ShenYu Github: https://github.com/apache/shenyu        
HertzBeat Github: https://github.com/dromara/hertzbeat 

**æ¬¢è¿äº†è§£ä½¿ç”¨Staræ”¯æŒå“¦ï¼**

åªéœ€è¦ä¸€æ¡dockerå‘½ä»¤å³å¯å®‰è£…ä½“éªŒheartbeat ï¼š   
`docker run -d -p 1157:1157 --name hertzbeat tancloud/hertzbeat`
