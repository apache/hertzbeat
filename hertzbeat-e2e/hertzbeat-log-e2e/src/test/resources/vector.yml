# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Vector configuration for HertzBeat E2E testing

api:
  enabled: true
  address: "0.0.0.0:8686"

sources:
  generate_syslog:
    type: "demo_logs"
    format: "syslog"
    count: 100000
    interval: 1

transforms:
  remap_syslog:
    inputs: ["generate_syslog"]
    type: "remap"
    source: |
      syslog = parse_syslog!(.message)

      severity_text = if includes(["emerg", "err", "crit", "alert"], syslog.severity) {
        "ERROR"
      } else if syslog.severity == "warning" {
        "WARN"
      } else if syslog.severity == "debug" {
        "DEBUG"
      } else if includes(["info", "notice"], syslog.severity) {
        "INFO"
      } else {
        syslog.severity
      }

      severity_number = if includes(["emerg", "err", "crit", "alert"], syslog.severity) {
        17
      } else if syslog.severity == "warning" {
        13
      } else if syslog.severity == "debug" {
        5
      } else if includes(["info", "notice"], syslog.severity) {
        9
      } else {
        9
      }

      .resourceLogs = [{
        "resource": {
          "attributes": [
            { "key": "source_type", "value": { "stringValue": .source_type } },
            { "key": "service.name", "value": { "stringValue": syslog.appname } },
            { "key": "host.hostname", "value": { "stringValue": syslog.hostname } }
          ]
        },
        "scopeLogs": [{
          "scope": {
            "name": syslog.msgid
          },
          "logRecords": [{
            "timeUnixNano": to_unix_timestamp!(syslog.timestamp, unit: "nanoseconds"),
            "body": { "stringValue": syslog.message },
            "severityText": severity_text,
            "severityNumber": severity_number,
            "attributes": [
              { "key": "syslog.procid", "value": { "stringValue": to_string(syslog.procid) } },
              { "key": "syslog.facility", "value": { "stringValue": syslog.facility } },
              { "key": "syslog.version", "value": { "stringValue": to_string(syslog.version) } }
            ]
          }]
        }]
      }]

      del(.message)
      del(.timestamp)
      del(.service)
      del(.source_type)

sinks:
  # Debug sink to log all processed data
  debug_console:
    inputs: [ "remap_syslog" ]
    type: console
    encoding:
      codec: json
  
  # Send to HertzBeat
  emit_syslog:
    inputs: [ "remap_syslog" ]
    type: opentelemetry
    protocol:
      type: http
      uri: "http://host.testcontainers.internal:${HERTZBEAT_PORT:-1157}/api/logs/ingest/otlp"
      method: post
      encoding:
        codec: json
      framing:
        method: newline_delimited
      headers:
        content-type: application/json
      auth:
        strategy: basic
        user: admin
        password: hertzbeat

